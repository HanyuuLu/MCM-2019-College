1. 聚类方法
   1. K-means

   	step 1`:`从数据集中随机选取K个样本作为初始聚类的中心$C={c_1,c_2,...,c_k}$
   	step 2:针对数据集中每个样本$x_i$,计算它到K个聚类中心的距离并将其分到距离最小的聚类中心所对应的类中
   	step 3:针对每个类别$c_i$，重新计算它的聚类中心$c_i=\frac{1}{\left|c_i\right|}\sum_{x \in c_i}x$(即属于该类的所有样本的质心)
   	step 4:重复第二步和第三步直到聚类中心的位置不再变化

   2. K-means++
   	step 1:从数据集中随机选取一个样本作为初始聚类的中心$c_i$;
   	step 2:首先计算每个样本与当前已有聚类中心之间的最短距离(即与最近的一个聚类中心的距离)，用$D(x)$表示;接着计算每个样本被选为下一个聚类中心的概率$\frac{D(x)^2}{\sum_{x\in X}D(x)^2}$。最后按照轮盘法选择出下一个聚类的中心
   	step 3:重复第二步直到选择出K个聚类中心

2. 数据错误以处理

	1. ~~由于2月份以后没有MetroNum、BusNum、BusMetroNum三个类型数据的信息，所以这里我们需要自行统计~~
	2. 数据~~错误~~缺失：有些用户记录的 BusNum+MetroNum!=BusMetroNum、乘车日期和时间的丢失、支付类型的丢失、乘车记录的丢失（当前有乘车当时没有记录）
	3. ~~重复记录（导致错误的挖掘模式，遍历的时候判断？SNM方法）~~
	4. 针对PAYTYPE的Null数值，鉴于我们数据的统计了每个人PAYTYPE 0与1的数量，我们可以根据相应的概率把Null值改为0或1中的某个值。时间填充方面可以划分24小时的乘车区间，根据相应乘车区间的数量，算出在每一区间乘车的概率，根据概率向Uptime和LastTime中填入数据
	5. 数据特征：每个月选取的数据都是一个星期内考虑了双休日的情况，所以数据给出的是比较合理的
	6. 针对乘车日期的缺失：假如一个用户当天多次乘车，上一次乘车UpTime丢失，判断是否可以用下一次乘车的LastTime补充

3. 支付特征提取（认为公交车和地铁为同一种类型）

	1. 综合考虑2、4、8、11月共4周情况，综合分析星期i的交易量，移动的交易占比（计算每天的平均交易量和移动支付交易量，两者相除得出占比），人均交易数（当天交易量除以当天的乘车人数）。
	2. 针对4个月中，每个月统计的那一周的线上支付占比（根据算出每月的线上支付占比，判断是否存在使用线上支付的人数越来越多的情况）。
	3. 根据4周的数据，分析一个人是否从不使用移动支付变为开始使用移动支付（新增用户）
	4. 分析各个时间段，移动支付的交易量和占比，支付量占全天支付量的百分比
	5. 分别分析工作日和双休日，公交的成交量和移动支付的占比
	6. 根据个人总乘车次数与相应的移动支付占比，分析移动支付占比也乘车次数之前的关系
	7. 根据聚类结果，分析每个聚类的支付情况和特征

4. 结论图表
   1. 横坐标为时间(日期)，纵坐标当天移动支付笔数，分析移动支付笔数和时间的关系（是否随着时间的推移，移动支付的交易量上升，柱状图）
   2. 横坐标为时间(日期)，纵坐标为当天公共交通支付总笔数，两者之间的关系（是否随着时间的推移，公共交通的支付总笔数是否平缓或者略有增加，柱状图）
   3. 横坐标为星期1-7，纵坐标为当天公共交通支付总笔数，分析两者之间的关系（工作日和休息日是否会改变该车乘车的总笔数，画4条不同颜色的折线，分别表示2月、5月、8月、11月）
   4. 横坐标为月份，纵坐标的移动支付的市场占比，分析两者之间的关系（移动支付的份额是否随着时间不断上升，折线图）
   5. 选出4个月中其中一个月，画出该月移动支付份额、公交卡支付份额的饼图
   6. 横坐标为$i$为$[i-1,i]$单位时间段，单位时间段的长度为$1$h，纵坐标为该时间段的平均乘车人次（综合考虑所有数据），分析该市乘车行为与乘车时间的关系，折线图
   7. 横坐标为公共交通出行的次数i（i=0，1，2，3，4，5，6...），纵坐标为移动支付的占比（移动支付的次数/总次数），这个图中每一个横坐标反映了一个人群：出行次数为i的人群。分析两者之间的关系（判断是否存在出行次数为i的人群更加倾向使用移动支付）

5. 新表

	1. 日均公交移动支付与总支付笔数小时分布图

	统计平均一天中每小时内的公交支付总笔与移动支付的总笔数，绘制柱状图，其中移动支付笔数包含在总笔数之中。

	---

	2. 公交移动支付与总支付笔数按日期分布图

	统计每天的公交支付笔数与公交移动支付笔数，按日期增长顺序绘制折线图。

	3. 公交移动支付占比图

	将4周每周的移动支付占比绘制饼图（4张）

	---

	4. 公交支付笔数星期内分布图

	将四周的公交支付笔数分别按一星期七天画出四条折线图

	5. 公交移动支付星期内分布图

	将四周的公交移动支付笔数分别按一星期七天画出四条折线图

	---

	6. 移动支付占比随乘车次数分布图

	计算乘车次数为i的乘客的移动支付笔数总和与总乘车次数和，之后求出乘车次数为i的移动支付笔数占总乘车次数比例，绘制移动支付占比随乘车次数增长的折线图。



6. 数学符号

|符号|说明|
|----|----|
|$SumCharge$|所有天数的公共交通支付笔数数目的总和|
|$SumCharge^{MobilePay}$|所有天数移动支付公共交通的成交量|
|$MonthlyCharge_i$|第$i$月一周的公共交通支付数目的总和|
|$MonthlyCharge^{MobilePay}_i$|第$i$月移动支付公共交通的笔数|
|$DailyCharge_{(i,j)}$|第$i$月星期$j$的公共交通支付笔数|
|$DailyCharge^{MobilePay}_{(i,j)}$|第i月星期j当天移动支付公共交通的笔数|
|$\overline {times}$|人均公交支付笔数|
|$\overline {times_i}$|第$i$月人均公交支付笔数|
|$\overline {times}_{(i,j)}$|第$i$月星期$j$的人均公交支付笔数|
|$\overline {times}^{mobilePay}_{(i,j)}$|第$i$月星期$j$的人均移动支付公共交通笔数|
|$Charge_{(i,j)}$|时间段i~j内,公共交通的支付量|
|$Charge_{(i,j)}^{mobilePay}$|时间段$i$~$j$内，移动支付公共交通的笔数|
|$Uptime_{m}^{i}$|乘客$m$在时间段$i\sim i+1$的乘车数量, $0\leq i \leq 23$|
|$P_m(i)$|乘客$m$在时间段$i\sim i+1$,乘车的概率|
|$CustomerSum(i)$|乘客$i$乘车总量|
|$CustomerSum(i)^{mobilePay}$|乘客$i$移动支付的数量|
1. 需要计算的数据：

	- 每天的移动支付数量
	- 每天的总支付数量
	- 每天的人数（ID去重）
	- ~~每天早高峰：7-9的移动支付数量与总支付数量~~
	- ~~每天晚高峰17-19的移动支付数量与总支付数量~~

2. 特征提取实现：

  1. ~~对于每天的移动支付占比，绘制：~~

  	~~散点图（按星期几排列）~~

  	~~柱状图（按日期排列）~~

  	~~饼状图（反应平均占比）~~
## 遍历结果
1. 第一次遍历Excel表(不进行数据清理)
   * 输入
     * ID
     * PayType
     * Uptime
   * 数据处理
     * 数据清洗
       * 对于乘车类型为NULL的值，直接改为$0$表示移动支付
       * 对于Uptime错误的数据
         * 如果该乘客相邻两次记录中，上一次的Uptime丢失，而下一次的乘车记录给出了LastTime，则我们使用下一次记录的LastTtime填充上一次记录的UpTime，否则按如下步骤填充
           * 注意这个上下次记录只有同一个月的相邻记录有效，不同月的相邻记录无效
         * 统计该乘客历史乘车记录
          $$P_m(i)=\frac{Uptime_{m}^{i}}{\sum_{k=0}^{\infty}Uptime_{m}^{k}}$$
		 * 根据$P_m(i)$给出乘车区间$i\sim i+1$的乘车概率，根据$P_m(i)$的值选择相应乘车区间的中间值乘积$i+\frac{1}{2}$，填充乘车日期的错误值
	* 数据清理
    	* 删除乘车次数$CustomerSum \leq 2$) 的数据，直 接把这个数据从哈希表里删除
   * 输出
     * 间表

   1. 时间段分时加入移动
   2. 下标重叠

### 数学符号

1. $S_{sum}$:销售总额

2. $Pay_{sum}$用户支付笔数

3. $FreeRate$:手续费率,针对用户

4. $ServiceRate$:服务费率,针对商户

5. $adFree$:$40RMB/CPM$

6. $\overline {remain}$:人均余额

7. ${NumberOfPeople}$:使用该第三方支付的人数（非人次）

8. $SedMoney(i)$:第i月的存入银行的资金

9. $SedMoney^j(i)$:第i月的沉淀资金经过$j$月以后的总额

10. $IncreaseRate$:沉淀资金的增长率

### 模型二：

1. 模型分析：
	1. 收入 ：
		* 有形收益：
    		- 手续费$T_1$：0.1%
    		- 服务费$T_2$：0.6%
    		- 广告费$T_3$：40RMB/CPM（待定）
    		- 沉淀资金（表达式）$T_4$：每三个月一次手续费（t1=0.78%），利润只能获取90%（风险），协议存款率（年）4%~5%，规定活期金额占比
		* 无形收益$T_5$：潜在提高总利润的$M\%$
    		* 客户资料
    		* 交易行为信用分析
    		* 交易金额、交易倾向分析
	2. 支出（运营成本）：
		- 固定成本：设备的安装成本，维修成本，劳动力成本
		- 推广成本
2. 盈利=收入-支出
3. 分析模型与支付宝模型的盈利（盈利/交易额）
2. 模型计算
   1. $T_1$=$S_{sum}*FreeRate$用户支付产生的收益
   2. $T_2$=$S_{sum}*ServiceRate$商户支付给第三方的服务费
   3. $T_3$=$Pay_{sum}*adFree/1000$ CPM广告产生费用
   4. $T_4$=
	  * $r=IncreaseRate = (1-r_1)(a_1*r_2+(1-a_1)*r_3)/12$
   		 * $r_1:风险准备金比例$
   		 * $a_1:活期资金占总资金比例$
   		 * $r_2:3个月的活期年利率$
   		 * $r_3:协定年利率$

      * $SedMoney(0)$:表示沉淀资金的初始值
        * $SedMoney(0)=(\overline {remian} * {NumberOfPeople})*a_3$
        * $a_3:发卡额的资金保有比例$$SedMoney^j(i)=\left\{
	       \begin{aligned}
		   & (1+r)*(1-t_1)SedMoney(i) &j
		   =1 \\
		   & (1+r)*(1-t_1)SedMoney^{j-1}(i) &j
		   =3n-2&&j != 1 \\
		  &(1+r)*SedMoney^{j-1}(i)  & j=3n-1\\
		  &(1+r)*SedMoney^{j-1}(i)  & j=3n\\
		  \end{aligned}
		  \right.
		  $


   $$T_4=\sum_{i=0}^{11} SedMoney^{12-i}(i)-\sum_{i=0}^{11} SedMoney(i)$$第12月要到明年结算

        第i个月的沉淀金过了j个月之后的值，r=IncreaseRate.
   1. 固定成本$O_1$：
新增机器数量\*一台机器的费用+平均工资*员工数量+已有机器数量*损坏率\*维修费用

   2. 推广费用$O_2$：投放广告数*广告均价
1.  总盈利$W$：$(T_1+T_2+T_3+T_4)*(1+T_5)-O_1-O_2$
6. 模型分析
   1. 分析总盈利情况
   2. 对比我们模型与支付宝的单位销售额盈利值，判断我们模型的优劣
7. 灵敏度分析
   1. 用户手续费的区间为[0.08%,1.25%]，协议存款率的浮动区间为[4%,5%]，分析这两个自变量在区间变化是，对我们模型盈利产生的影响
   2. 分析不同的CPM产生的广告费，对模型盈利产生的影响

### 模型三
1. 模型建立
   1. 根据南京地铁数据，分析出最热门的$1/4$线路的客流量占比
   2. 假设，本题城市在最热门的$1/4$的线路，试运营移动支付
2. 求解1/4线路中移动支付的份额
   1. 已知南京地铁热门$1/4$线路客流量占比为$m_1$
   2. 第i月第j天1/4线路中移动支付占比$MobileProportion(i,j)$为
   $$MobileProportion(i,j)=DailyCharge^{MobilePay}_{(i,j)}/(DailyCharge_{(i,j)}*m_1)$$
3. 模型分析
   1. 根据上述数据，我们可以画出试运营期间$1/4$的线路移动支付的份额随时间推移的曲线图（暂定用logistics回归来拟合）
   2. 将$1/4$的线路推广到全体线路，得出全体线路的移动支付份额随时间的推移，画出盈利曲线与时间的关系
4. 南京线路    
  
| 线路 | 里程 |
| ------ | ------ | 
| 1号线| 37.5Km|
|2号线|37.1Km|
|3号线|43.9Km|
|4号线|32.6Km|
|10号线|21.2Km|
|S1号线|33.0Km|
|S3号线|35.5Km|
|S7号线|28.2Km|
|S8号线|44.4Km|
|S9号线|51.9Km|

